{% extends 'home/base.html' %}
{% load static %}
{% load i18n %}

{% block content %}
<div class="container mt-5">
    <div class="bg-white p-4 rounded-lg shadow-lg">
        <h2 class="text-dark font-weight-bold mb-4">{% trans "Crear Producto" %}</h2>
        
        {% if messages %}
            {% for message in messages %}
                <div class="alert {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            {% endfor %}
        {% endif %}
        
        <form method="post">
            {% csrf_token %}
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="id_nombre" class="form-label">{% trans "Nombre" %}</label>
                    <input type="text" name="nombre" id="id_nombre" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="id_categoria" class="form-label">{% trans "Categoría" %}</label>
                    <div class="d-flex">
                        <select name="categoria" id="id_categoria" class="form-control">
                            <option value="">{% trans "Selecciona una categoría" %}</option>
                            {% for categoria in categorias %}
                                <option value="{{ categoria.id }}">{{ categoria.nombre }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-primary btn-sm ml-2" data-toggle="modal" data-target="#categoriaModal">+</button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="id_subcategoria" class="form-label">{% trans "Subcategoría" %}</label>
                    <select name="subcategoria" id="id_subcategoria" class="form-control">
                        <option value="">{% trans "Selecciona una subcategoría" %}</option>
                        {% for subcategoria in subcategorias %}
                            <option value="{{ subcategoria.id }}" data-categoria="{{ subcategoria.categoria.id }}">{{ subcategoria.nombre }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="id_marca" class="form-label">{% trans "Marca" %}</label>
                    <div class="d-flex">
                        <select name="marca" id="id_marca" class="form-control">
                            <option value="">{% trans "Selecciona una marca" %}</option>
                            {% for marca in marcas %}
                                <option value="{{ marca.id }}">{{ marca.nombre }}</option>
                            {% endfor %}
                        </select>
                        <button type="button" class="btn btn-primary btn-sm ml-2" data-toggle="modal" data-target="#marcaModal">+</button>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="id_precio" class="form-label">{% trans "Precio (USD)" %}</label>
                    <input type="number" step="0.01" name="precio" id="id_precio" class="form-control" required>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="id_stock" class="form-label">{% trans "Stock" %}</label>
                    <input type="number" step="1" name="stock" id="id_stock" class="form-control" required>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="id_codigo_barras" class="form-label">{% trans "Código de Barras" %}</label>
                    <input type="text" name="codigo_barras" id="id_codigo_barras" class="form-control">
                </div>
                <div class="col-md-6 mb-3">
                    <label for="id_ubicacion_deposito" class="form-label">{% trans "Ubicación en Depósito" %}</label>
                    <input type="text" name="ubicacion_deposito" id="id_ubicacion_deposito" class="form-control">
                </div>
            </div>
            <div class="mb-3">
                <label for="id_descripcion" class="form-label">{% trans "Descripción" %}</label>
                <textarea name="descripcion" id="id_descripcion" class="form-control" rows="3"></textarea>
            </div>
            <button type="submit" class="btn btn-success w-100">{% trans "Guardar" %}</button>
        </form>
    </div>
</div>

<!-- Modal para Crear Categoría -->
<div class="modal fade" id="categoriaModal" tabindex="-1" aria-labelledby="categoriaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Categoría</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="nuevaCategoria" class="form-control" placeholder="Nombre de la categoría">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="guardarCategoria()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Crear Marca -->
<div class="modal fade" id="marcaModal" tabindex="-1" aria-labelledby="marcaModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Marca</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <input type="text" id="nuevaMarca" class="form-control" placeholder="Nombre de la marca">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="guardarMarca()">Guardar</button>
            </div>
        </div>
    </div>
</div>

<script>
    function guardarMarca() {
        let nombre = document.getElementById("nuevaMarca").value;
        if (!nombre) return;
        
        fetch("{% url 'agregar_marca' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({ nombre: nombre })
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                let marcaSelect = document.getElementById("id_marca");
                let nuevaOpcion = new Option(data.nombre, data.id);
                marcaSelect.add(nuevaOpcion);
                $("#marcaModal").modal("hide");
            }
        });
    }

    function guardarCategoria() {
    let nombre = document.getElementById("nuevaCategoria").value;
    if (!nombre) return;
    
    fetch("{% url 'agregar_categoria' %}", {  
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: JSON.stringify({ nombre: nombre })
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            let categoriaSelect = document.getElementById("id_categoria");
            let nuevaOpcion = new Option(data.nombre, data.id);
            categoriaSelect.add(nuevaOpcion);
            $("#categoriaModal").modal("hide");
            document.getElementById("nuevaCategoria").value = ""; // Limpiar campo
        } else {
            alert("Error al agregar la categoría");
        }
    })
    .catch(error => console.error("Error:", error));
}
</script>
{% endblock %}
